# Trouble notes

The combination of container, Ubuntu and Puppeteer is a challenge. When you also want to have a multi-arch container, so it runs on x86 and ARM, it becomes a real challenge.
I will try to explain why and how I solved it.

* Ubuntu uses snap for installs, snap does not work in containers.
* Puppeteer needs a browser, the default browser is Chromium.
* Chromium is not available for ARM64.
* Firefox is available for ARM64, but only if installed from mozilla repository (if you try to install it fron ubuntu repo it wil use snap and fail).
* Chrome is can be installed directly from google, but I only got it working on x86.

Getting this working has taken hours.

The solution was to use Firefox from mozilla repository as they just announced (version 23 / August 7, 2024) [Puppeteer support for Firefox](https://hacks.mozilla.org/2024/08/puppeteer-support-for-firefox/).

## test-install.sh

The test-install.sh script is used to verify that the container is working.

So first log in to the container and run the script.

```bash
docker run --rm -it -v ${PWD}:/data docuwrite-base bash
```

Then in the container run the script:

```bash
test-install
```

The output is from a container running on my MacBook M2 cpu.

```plaintext
est-install
=== Testing Installation ===

✓ Xvfb is running on display :99
=== Node.js Version ===
v20.18.1

=== NPM Version ===
10.9.1

=== Firefox Version ===
Mozilla Firefox 135.0a1

=== Pandoc Version ===
pandoc 3.5
Features: +server +lua
Scripting engine: Lua 5.4
User data directory: /usr/local/share/pandoc
Copyright (C) 2006-2024 John MacFarlane. Web: https://pandoc.org
This is free software; see the source for copying conditions. There is no
warranty, not even for merchantability or fitness for a particular purpose.

=== Puppeteer Installation ===
✓ Puppeteer-core is installed
Puppeteer-core version: 23.9.0

=== Mermaid-CLI Version ===
11.4.0

=== Marp CLI Version ===
@marp-team/marp-cli v4.0.3 (w/ @marp-team/marp-core v4.0.0)

=== Directory Structure ===
Content of /usr/local/app (npm packages):
total 56
drwxr-xr-x  1 root root  4096 Dec  3 07:59 .
drwxr-xr-x  1 root root  4096 Dec  3 08:00 ..
drwxr-xr-x 92 root root  4096 Dec  3 07:59 node_modules
-rw-r--r--  1 root root 36687 Dec  3 07:59 package-lock.json
-rw-r--r--  1 root root   274 Dec  3 07:59 package.json

Content of /usr/local/tests (test files):
total 76
drwxr-xr-x 1 root root  4096 Dec  3 07:58 .
drwxr-xr-x 1 root root  4096 Dec  3 08:00 ..
-rw-r--r-- 1 root root  6451 Dec  2 09:28 docuwrite-logo-min.png
-rw-r--r-- 1 root root 17273 Dec  2 09:28 docuwrite-logo.png
-rw-r--r-- 1 root root  1415 Dec  2 09:28 markdown-diagram.md
-rw-r--r-- 1 root root   399 Dec  2 09:28 mermaid-diagram.mmd
-rw-r--r-- 1 root root  5833 Dec  3 07:54 puppeteer-test.js
-rw-r--r-- 1 root root    47 Dec  2 09:28 simple-markdown.md
-rw-r--r-- 1 root root  1303 Dec  2 09:28 slide-deck.md
-rwxr-xr-x 1 root root  8019 Dec  3 06:48 test-install.sh

=== Testing Conversions ===

Testing Mermaid Diagram to PNG...
Generating single mermaid chart
[@zenuml/core] Store is a function and is not initiated in 1 second.
✓ Successfully created mermaid-diagram.png

Testing Simple Pandoc Markdown to PDF...
✓ Successfully created simple-markdown.pdf

Testing Simple Pandoc Markdown to DOCX...
✓ Successfully created simple-markdown.docx

Processing Markdown with Mermaid diagrams...
Found 1 mermaid charts in Markdown input
 ✅ ./markdown-diagram-image-1.png
 ✅ markdown-diagram-image.md
✓ Successfully created markdown-diagram-image.md

Converting processed Markdown to PDF...
✓ Successfully created markdown-diagram.pdf

Converting processed Markdown to DOCX...
✓ Successfully created markdown-diagram.docx

Testing Marp Slide Deck to PDF...
[  INFO ] Converting 1 markdown...
[  WARN ] Using Firefox to convert Markdown to PDF: The output may include some incompatible renderings compared to the PDF generated by Chrome.
[  WARN ] Insecure local file accessing is enabled for conversion from slide-deck.md.
[  INFO ] slide-deck.md => slide-deck.pdf
✓ Successfully created slide-deck.pdf

Testing Marp Slide Deck to PPTX...
[  INFO ] Converting 1 markdown...
[  WARN ] Insecure local file accessing is enabled for conversion from slide-deck.md.
[  INFO ] slide-deck.md => slide-deck.pptx
✓ Successfully created slide-deck.pptx

=== Testing Puppeteer Integration ===
Using Puppeteer config from: /usr/local/etc/puppeteer-config.json
=== Running Puppeteer Tests ===

✓ Browser launched successfully with config from PUPPETEER_CONFIG
✓ New page created
✓ Viewport manipulation successful
✓ Basic page navigation successful
✓ DOM manipulation successful
✓ Navigated to example.com

Example.com Content:
- Title: Example Domain
- Heading: Example Domain
- First Paragraph: This domain is for use in illustrative examples in documents. You may use this
    domain in literature without prior coordination or asking for permission.
✓ Example.com screenshot captured
✓ Example.com PDF generated
✓ Test page PDF generation successful

Note: Performance metrics collection not supported

✓ Browser closed successfully

=== All Puppeteer tests completed successfully ===

Verifying Puppeteer test outputs...
✓ Successfully created puppeteer-example-screenshot.png
✓ Successfully created puppeteer-example-page.pdf
✓ Successfully created puppeteer-test-page.pdf

=== Verifying All Generated Files ===
Checking file creation and sizes...
✓ Successfully created mermaid-diagram.png
✓ Successfully created simple-markdown.pdf
✓ Successfully created simple-markdown.docx
✓ Successfully created markdown-diagram-image.md
✓ Successfully created markdown-diagram.pdf
✓ Successfully created markdown-diagram.docx
✓ Successfully created slide-deck.pdf
✓ Successfully created slide-deck.pptx
✓ Successfully created puppeteer-example-screenshot.png
✓ Successfully created puppeteer-example-page.pdf
✓ Successfully created puppeteer-test-page.pdf

Final file listing:
-rw-rw-r-- 1 root root 1.1K Dec  3 08:00 markdown-diagram-image.md
-rw-rw-r-- 1 root root  90K Dec  3 08:00 markdown-diagram.docx
-rw-rw-r-- 1 root root  80K Dec  3 08:00 markdown-diagram.pdf
-rw-rw-r-- 1 root root  67K Dec  3 08:00 mermaid-diagram.png
-rw-rw-r-- 1 root root  18K Dec  3 08:01 puppeteer-example-page.pdf
-rw-rw-r-- 1 root root  45K Dec  3 08:01 puppeteer-example-screenshot.png
-rw-rw-r-- 1 root root  12K Dec  3 08:01 puppeteer-test-page.pdf
-rw-rw-r-- 1 root root  11K Dec  3 08:00 simple-markdown.docx
-rw-rw-r-- 1 root root 6.1K Dec  3 08:00 simple-markdown.pdf
-rw-rw-r-- 1 root root  84K Dec  3 08:01 slide-deck.pdf
-rw-rw-r-- 1 root root 1.3M Dec  3 08:01 slide-deck.pptx

=== All tests completed successfully ===
```